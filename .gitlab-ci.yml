variables:
  AutoMix: "Automix Software\\AutoMix Software.sln"
  IOLib: "InputOutputLibrary\\InputOutputLibrary.sln"
  ExtractLib: "DataExtractionLibrary\\DataExtractionLibrary.sln"
  TestsLib: "Automix Software\\Debug\\AutoMix Tests.dll"
  TestsFile: "Automix Software\\TestResults\\tests.xml"
  ReleaseDir: "Automix Software\\Debug\\"
  DebugMode: "Debug|x86"
  ReleaseMode: "Debug|x86"

before_script:
  - 'call "D:\Programmes\Visual Studio Enterprise 2015\VC\bin\amd64\vcvars64.bat"'

stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - echo building...
    - 'devenv "%IOLib%" /Build "%DebugMode%"'
    - 'devenv "%ExtractLib%" /Build "%DebugMode%"'
    - 'devenv "%AutoMix%" /Build "%DebugMode%"'
  except:
    - tags
  artifacts:
    paths:
      - Automix Software/Debug
    expire_in: 20 minutes


test:
  stage: test
  script:
    - echo testing...
    - 'mkdir "Automix Software\\TestResults"'
    - 'mstest.exe /testcontainer:"%TestsLib%" /resultsfile:"%TestsFile%"'
  except:
    - tags

deploy:
  stage: deploy
  script:
    - echo deploying...
    - 'devenv "%IOLib%" /Build "%ReleaseMode%"'
    - 'devenv "%ExtractLib%" /Build "%ReleaseMode%"'
    - 'devenv "%AutoMix%" /Build "%ReleaseMode%"'
    - 'cd "%ReleaseDir%"'
    - 'for %%i in (*.exe *.dll) do attrib -a %%i /s'
    - 'del *.* /s /a:a /q'
    - 'attrib +a *.* /s'
  artifacts:
    paths:
      - "%ReleaseDir%"
    expire_in: 1 week
  only:
    - master