variables:
  AutoMix: "Automix Software.sln"
  AITestsLib: "Automix AI Tests\\bin\\Debug\\Automix AI Tests.dll"
  AITestsFile: "Automix Software\\TestResults\\ai_test.xml"
  
before_script:
  - 'call "D:\Programmes\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvars64.bat"'
  - echo "Restoring NuGet Packages..."
  - 'msbuild /t:restore /p:Platform="Any CPU" "%AutoMix%"'

stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - echo "Building..."
    - 'msbuild /m /nologo /p:Configuration=Debug;Platform="Any CPU" "%AutoMix%"'
  dependencies: []
  except:
    - tags
  artifacts:
    paths:
      - Automix UI/bin/Debug
    expire_in: 10 minutes 

test:
  stage: test
  script:
    - echo "Testing..."
    - 'mkdir "Automix Software\\TestResults"'
    - 'mstest.exe /testcontainer:"%AITestsLib%" /resultsfile:"%AITestsFile%"'
  dependencies:
    - build
  except:
    - tags
    
deploy:
  stage: deploy
  script:
    - echo "Deploying..."
    - 'msbuild /m /nologo /p:Configuration=Release;Platform="Any CPU" "%AutoMix%"'
  dependencies: []
  artifacts:
    paths:
      - Automix UI/bin/Release
    expire_in: 2 weeks
  only:
    - master